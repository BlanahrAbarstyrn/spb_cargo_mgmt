<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Sam Porter Bridges Cargo Optimizer</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.1)),
                  /* url('../assets/ladderoverchasm.jpg') center/cover fixed; */
                  url('ladderoverchasm.jpg') center/cover fixed;
      color: #ffffff;
      min-height: 100vh;
    }

    .parent-container {
      display: flex;
      flex-wrap: wrap;
      padding: 10px;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      box-sizing: border-box;
    }

    .child-container-slim {
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 350px;
      gap: 10px;
      padding: 10px;
    }

    .child-container-wide {
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 750px;
      gap: 10px;
      padding: 10px;
    }
    
    .content {
      min-height: 200px;
      padding: 10px;
      position: relative;
      width: 100%;
      z-index: 1;
    }
    
    h1 {
      color: #4CAF50;
      font-size: 48px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
    }
    
    .section {
      background-color: rgba(42, 42, 42, 0.6);
      padding: 20px;
      margin: 15px 0;
      border-radius: 8px;
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    h2, h3, h4 {
      color: #ffffff;
      margin-top: 0;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
    }
    
    .load-container {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }

    .body-slots-container {
      flex: 1;
      min-width: 300px;
    }

    .backpack-container {
      flex: 1;
      min-width: 300px;
    }

    /* On very narrow screens, make them stack */
    @media (max-width: 650px) {
      .load-container {
        flex-direction: column;
      }
  
      .body-slots-container,
      .backpack-container {
        min-width: 100%;
      }
    }

    input, select {
      background-color: rgba(51, 51, 51, 0.9);
      color: white;
      border: 1px solid #555;
      padding: 8px;
      margin: 5px;
      border-radius: 4px;
    }
    
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
      margin: 5px;
    }
    
    button:hover {
      background-color: #45a049;
    }
    
    .cargo-item {
      background-color: rgba(60, 60, 60, 0.7);
      padding: 15px;
      margin: 10px 0;
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .body-slot {
      margin: 10px 0;
    }
    
    label {
      display: block;
      margin: 8px 0;
    }
  </style>
</head>

<body>
  <div class="parent-container">
    <div class="content">
      <h1>Sam Porter Bridges Cargo Optimizer</h1>
      <p>Keep on keeping on! üì¶ --- created for the original Death Stranding video game</p>
      <p>Image credit: „Çπ„Éº„Éë„ÉºÂàùÂøÉËÄÖ Super Newb</p>
    </div>

    <div class="child-container-slim">
      <div class="section">
        <h2>Sam's Status</h2>
        <label>Suit Configuration:
          <select id="suitType" onchange="applySuitConfiguration()">
            <option value="standard">Standard Suit</option>
            <option value="power-1">Power Skeleton Lv.1</option>
            <option value="power-2">Power Skeleton Lv.2</option>
            <option value="power-3">Power Skeleton Lv.3</option>
            <option value="speed-1">Speed Skeleton Lv.1</option>
            <option value="speed-2">Speed Skeleton Lv.2</option>
            <option value="speed-3">Speed Skeleton Lv.3</option>
            <option value="all-terrain-1">All-Terrain Skeleton Lv.1</option>
            <option value="all-terrain-2">All-Terrain Skeleton Lv.2</option>
            <option value="all-terrain-3">All-Terrain Skeleton Lv.3</option>
            <option value="hazmat">Hazmat Suit (No body slots)</option>
          </select>
        </label>
        <label>Base Carrying Capacity (from game UI): <input type="number" id="baseCapacity" value="120" /></label>
        <label>Additional Gear Weight: <input type="number" step="0.1" id="gearWeight" value="0" placeholder="Tools, weapons..." /></label>
        <label>Chiralium Crystals: <input type="number" id="chiraliumCrystals" value="0" placeholder="Total crystals carried" /></label>
        <label>Safety Buffer: 
          <select id="safetyBuffer" onchange="updateCurrentLoad()">
            <option value="0">No Buffer (Max capacity)</option>
            <option value="0.1" selected>0.1kg Buffer (Recommended)</option>
            <option value="0.5">0.5kg Buffer</option>
            <option value="1.0">1.0kg Buffer</option>
            <option value="2.0">2.0kg Buffer</option>
            <option value="5.0">5.0kg Buffer (Conservative)</option>
          </select>
        </label>
        <div id="suit-bonus" style="margin-top: 5px; color: #ffaa00;"></div>
        <div id="chiralium-boost" style="margin-top: 5px; color: #00ccff;"></div>
        <div id="effective-capacity" style="margin-top: 10px; font-weight: bold; color: #4CAF50;"></div>
      </div>

      <div class="section">
        <h2>Priority Legend</h2>
        <p>5 => Story-critical</p>
        <p>4 => Sam's Orders</p>
        <p>3 => Standard Orders</p>
        <p>2 => Location: Facilities on the way or already a destination</p>
        <p>1 => High Rewards/Likes for recovery</p>
        <h5>* This list is just a suggestion. Optimization will be based on how each piece of cargo is rated. Or leave all cargo set to default "3" to ignore priority during optimization.</h5>
      </div>
    </div>

    <div class="child-container-wide">
      <div class="section">
        <h2>Sam's Current Load</h2>
          <div id="current-load-summary" style="margin-top: 15px; padding: 10px; background-color: rgba(60, 60, 60, 0.8); border-radius: 6px;">
            <!-- Load summary will be displayed here -->
          </div>
        </div>

      <div class="section">
        <div class="load-container">
          <div class="body-slots-container">
            <h3>Attached to Suit (S items only)</h3>
            <div id="body-slot-items">
            <div class="body-slot">
              <label>Left Arm:</label>
              <div class="cargo-item">
                <label>Status: 
                  <select id="leftArmStatus" onchange="toggleBodySlot('leftArm')">
                    <option value="">Empty</option>
                    <option value="occupied">S Item (1 unit)</option>
                  </select>
                </label>
                <div id="leftArmDetails" style="display: none;">
                  <label>Name: <input type="text" id="leftArmName" placeholder="Item name" onchange="updateBodySlot('leftArm')" /></label>
                  <label>Weight: <input type="number" step="0.1" id="leftArmWeight" placeholder="5.0" onchange="updateBodySlot('leftArm')" /></label>
                  <label>Priority: <input type="number" min="1" max="5" id="leftArmPriority" placeholder="3" onchange="updateBodySlot('leftArm')" /></label>
                </div>
              </div>
            </div>
        
          <div class="body-slot">
            <label>Right Arm:</label>
            <div class="cargo-item">
              <label>Status: 
                <select id="rightArmStatus" onchange="toggleBodySlot('rightArm')">
                  <option value="">Empty</option>
                  <option value="occupied">S Item (1 unit)</option>
                </select>
              </label>
              <div id="rightArmDetails" style="display: none;">
                <label>Name: <input type="text" id="rightArmName" placeholder="Item name" onchange="updateBodySlot('rightArm')" /></label>
                <label>Weight: <input type="number" step="0.1" id="rightArmWeight" placeholder="5.0" onchange="updateBodySlot('rightArm')" /></label>
                <label>Priority: <input type="number" min="1" max="5" id="rightArmPriority" placeholder="3" onchange="updateBodySlot('rightArm')" /></label>
              </div>
            </div>
          </div>
    
          <div class="body-slot">
            <label>Left Leg:</label>
            <div class="cargo-item">
              <label>Status: 
                <select id="leftLegStatus" onchange="toggleBodySlot('leftLeg')">
                  <option value="">Empty</option>
                  <option value="occupied">S Item (1 unit)</option>
                </select>
              </label>
              <div id="leftLegDetails" style="display: none;">
                <label>Name: <input type="text" id="leftLegName" placeholder="Item name" onchange="updateBodySlot('leftLeg')" /></label>
                <label>Weight: <input type="number" step="0.1" id="leftLegWeight" placeholder="5.0" onchange="updateBodySlot('leftLeg')" /></label>
                <label>Priority: <input type="number" min="1" max="5" id="leftLegPriority" placeholder="3" onchange="updateBodySlot('leftLeg')" /></label>
              </div>
            </div>
          </div>
    
          <div class="body-slot">
            <label>Right Leg:</label>
            <div class="cargo-item">
              <label>Status: 
                <select id="rightLegStatus" onchange="toggleBodySlot('rightLeg')">
                  <option value="">Empty</option>
                  <option value="occupied">S Item (1 unit)</option>
                </select>
              </label>
              <div id="rightLegDetails" style="display: none;">
                <label>Name: <input type="text" id="rightLegName" placeholder="Item name" onchange="updateBodySlot('rightLeg')" /></label>
                <label>Weight: <input type="number" step="0.1" id="rightLegWeight" placeholder="5.0" onchange="updateBodySlot('rightLeg')" /></label>
                <label>Priority: <input type="number" min="1" max="5" id="rightLegPriority" placeholder="3" onchange="updateBodySlot('rightLeg')" /></label>
              </div>
            </div>
          </div>
        </div>
      </div>

        
          <div class="backpack-container">
            <h3>Carried on Back</h3>
            <div id="backpack-items">
              <!-- Individual backpack items will be listed here -->
            </div>
            <button onclick="addBackpackItem()">Add Item to Back</button>
          </div>
        </div>
      </div>
    </div>

      <div class="child-container-slim">
        <div class="section">
          <h2>Cargo in Vicinity</h2>
          <div id="available-cargo">
        </div>
          <button onclick="addCargoItem()">Add Another Available Item</button>
      </div>
    </div>
      <div class="child-container-wide">
        <div class="section">
          <h2>Optimization</h2>
          <div style="margin-bottom: 15px;">
            <label>Algorithm: 
              <select id="algorithmChoice" onchange="toggleStrategyOptions()">
                <option value="greedy">Greedy (Fast)</option>
                <option value="dynamic">Dynamic Programming (Optimal)</option>
                <option value="compare">Compare Both</option>
              </select>
            </label>
          </div>
          <div id="greedyOptions" style="margin-bottom: 15px;">
            <label>Greedy Strategy: 
              <select id="greedyStrategy">
                <option value="value-weight">Value/Weight Ratio - Maximum efficiency</option>
                <option value="priority-first">Priority First - Urgent deliveries</option>
                <option value="size-efficiency">Size Efficiency - Fit more items</option>
              </select>
            </label>
          </div>
          <button onclick="optimizeCargo()">üéØ Optimize Load</button>
          <div id="results" style="margin-top: 15px;"></div>
        </div>

        <div class="section">
          <h2>Save/Load Configuration</h2>
  
          <!-- Auto-save status -->
          <div style="margin-bottom: 15px; padding: 10px; background-color: rgba(60, 60, 60, 0.8); border-radius: 4px;">
            <div style="color: #4CAF50; margin-bottom: 5px;">
              <small>‚úÖ Auto-saved: <span id="lastSaved">Never</span></small>
            </div>
            <div style="color: #00ccff;">
              <small>üíæ Save Slots: 
                <button onclick="saveToSlot(1)" style="padding: 4px 8px; margin: 2px;">Save 1</button>
                <button onclick="loadFromSlot(1)" style="padding: 4px 8px; margin: 2px;">Load 1</button>
                <button onclick="saveToSlot(2)" style="padding: 4px 8px; margin: 2px;">Save 2</button>
                <button onclick="loadFromSlot(2)" style="padding: 4px 8px; margin: 2px;">Load 2</button>
                <button onclick="saveToSlot(3)" style="padding: 4px 8px; margin: 2px;">Save 3</button>
                <button onclick="loadFromSlot(3)" style="padding: 4px 8px; margin: 2px;">Load 3</button>
              </small>
            </div>
          </div>
  
          <!-- File-based options -->
          <button onclick="downloadSaveFile()">‚¨áÔ∏è Download Save File</button>
          <input type="file" id="uploadFile" accept=".json" onchange="uploadSaveFile(event)" style="display: none;">
          <button onclick="document.getElementById('uploadFile').click()">‚¨ÜÔ∏è Upload Save File</button>
          <button onclick="clearAllData()" style="background-color: #ff4444; margin-left: 10px;">üóëÔ∏è Clear All Data</button>
        </div>
      </div>
    </div>
  </div>
</body>
</html>

<!-------------------------------THE END OF HTML CODE AND THE THE BEGINNING OF SCRIPT CODE-------------------------------------------->


<script>
// -----------------------------------------------------GLOBAL VARIABLES / DATA--------------------------------------------------------
// Global arrays to track current cargo
let currentBackpackItems = [];
let currentBodySlotItems = {
  leftArm: null,
  rightArm: null,
  leftLeg: null,
  rightLeg: null
};

// Suit configuration data
const suitConfigurations = {
  'standard': {
    name: 'Standard Suit',
    weight: 0,
    slots: { leftArm: true, rightArm: true, leftLeg: true, rightLeg: true }
  },
  'power-1': {
    name: 'Power Skeleton Lv.1',
    weight: 10, // weight of the skeleton itself
    slots: { leftArm: true, rightArm: true, leftLeg: false, rightLeg: false }
  },
  'power-2': {
    name: 'Power Skeleton Lv.2',
    weight: 8,
    slots: { leftArm: true, rightArm: true, leftLeg: false, rightLeg: false }
  },
  'power-3': {
    name: 'Power Skeleton Lv.3',
    weight: 6,
    slots: { leftArm: true, rightArm: true, leftLeg: false, rightLeg: false }
  },
  'speed-1': {
    name: 'Speed Skeleton Lv.1',
    weight: 6,
    slots: { leftArm: true, rightArm: true, leftLeg: true, rightLeg: true }
  },
  'speed-2': {
    name: 'Speed Skeleton Lv.2',
    weight: 4,
    slots: { leftArm: true, rightArm: true, leftLeg: true, rightLeg: true }
  },
  'speed-3': {
    name: 'Speed Skeleton Lv.3',
    weight: 2,
    slots: { leftArm: true, rightArm: true, leftLeg: true, rightLeg: true }
  },
  'all-terrain-1': {
    name: 'All-Terrain Skeleton Lv.1',
    weight: 8,
    slots: { leftArm: true, rightArm: true, leftLeg: true, rightLeg: true }
  },
    'all-terrain-2': {
    name: 'All-Terrain Skeleton Lv.2',
    weight: 6,
    slots: { leftArm: true, rightArm: true, leftLeg: true, rightLeg: true }
  },
    'all-terrain-3': {
    name: 'All-Terrain Skeleton Lv.3',
    weight: 4,
    slots: { leftArm: true, rightArm: true, leftLeg: true, rightLeg: true }
  },
  'hazmat': {
    name: 'Hazmat Suit',
    weight: 0,
    slots: { leftArm: false, rightArm: false, leftLeg: false, rightLeg: false }
  },
};
// -----------------------------------------------------END GLOBAL VARIABLES / DATA--------------------------------------------------------


// -----------------------------------------------------UI MANAGEMENT FUNCTIONS------------------------------------------------------------

function addBackpackItem() {
  const item = {
    id: Date.now(), // Simple unique ID
    name: '',
    weight: 0,
    size: 1,
    priority: 3
  };
  
  currentBackpackItems.push(item);
  renderBackpackItems();
  updateCurrentLoad();
}

function renderBackpackItems() {
  const container = document.getElementById('backpack-items');
  container.innerHTML = '';
  
  currentBackpackItems.forEach((item, index) => {
    const itemDiv = document.createElement('div');
    itemDiv.className = 'cargo-item';
    itemDiv.innerHTML = `
      <label>Name: <input type="text" value="${item.name}" onchange="updateBackpackItem(${index}, 'name', this.value)" /></label>
      <label>Weight: <input type="number" step="0.1" value="${item.weight}" onchange="updateBackpackItem(${index}, 'weight', parseFloat(this.value))" /></label>
      <label>Size: 
        <select onchange="updateBackpackItem(${index}, 'size', parseInt(this.value))">
          <option value="1" ${item.size === 1 ? 'selected' : ''}>S (1 unit)</option>
          <option value="2" ${item.size === 2 ? 'selected' : ''}>M (2 units)</option>
          <option value="4" ${item.size === 4 ? 'selected' : ''}>L (4 units)</option>
          <option value="6" ${item.size === 6 ? 'selected' : ''}>XL (6 units)</option>
        </select>
      </label>
      <label>Priority: <input type="number" min="1" max="5" value="${item.priority}" onchange="updateBackpackItem(${index}, 'priority', parseInt(this.value))" /></label>
      <button onclick="removeBackpackItem(${index})" style="background-color: #ff4444;">Remove</button>
    `;
    container.appendChild(itemDiv);
  });
}

function updateBackpackItem(index, field, value) {
  if (currentBackpackItems[index]) {
    if (field === 'weight') {
      value = Math.abs(parseFloat(value)) || 0; // Clean here
    } else if (field === 'priority') {
      value = parseInt(value) || 5;
    }
    currentBackpackItems[index][field] = value;

    // Manually trigger update for programmatic changes
    updateCurrentLoad();
  }
}

function removeBackpackItem(index) {
  currentBackpackItems.splice(index, 1);
  renderBackpackItems();
  updateCurrentLoad();
}

function toggleBodySlot(slot) {
  const status = document.getElementById(slot + 'Status').value;
  const details = document.getElementById(slot + 'Details');
  
  if (status === 'occupied') {
    details.style.display = 'block';
  } else {
    details.style.display = 'none';
    // Clear the input fields when set to empty
    document.getElementById(slot + 'Name').value = '';
    document.getElementById(slot + 'Weight').value = '';
    document.getElementById(slot + 'Priority').value = '';
    currentBodySlotItems[slot] = null;
  }
  // COMMENT OUT OR REMOVE THIS LINE:
  //updateBodySlot(slot);
}

function updateBodySlot(slot) {
  const status = document.getElementById(slot + 'Status').value;
  
  if (status === 'occupied') {
    const name = document.getElementById(slot + 'Name').value || 'Unnamed Item';
    const weight = Math.abs(parseFloat(document.getElementById(slot + 'Weight').value)) || 0;
    const priority = parseInt(document.getElementById(slot + 'Priority').value) || 3;
    
    currentBodySlotItems[slot] = {
      name: name,
      weight: weight, // Now guaranteed positive
      size: 1, // Always 1 for body slots
      priority: priority
    };
  } else {
    currentBodySlotItems[slot] = null;
  }

  updateCurrentLoad();
}

function addCargoItem() {
  const container = document.getElementById('available-cargo');
  const itemId = Date.now() + Math.random(); // Unique ID for tracking
  const newItem = document.createElement('div');
  newItem.className = 'cargo-item';
  newItem.setAttribute('data-item-id', itemId);
  newItem.innerHTML = `
    <label>Item Name: <input type="text" placeholder="Cargo Item" /></label>
    <label>Weight: <input type="number" step="0.1" placeholder="10.0" /></label>
    <label>Size: 
      <select class="cargo-size">
        <option value="1">S (1 unit)</option>
        <option value="2">M (2 units)</option>
        <option value="4">L (4 units)</option>
        <option value="6">XL (6 units)</option>
      </select>
    </label>
    <label>Priority: <input type="number" min="1" max="5" placeholder="3" /></label>
    <button onclick="removeAvailableItem('${itemId}')" style="background-color: #ff4444;">Remove</button>
  `;
  container.appendChild(newItem);
}

function removeAvailableItem(itemId) {
  const item = document.querySelector(`[data-item-id="${itemId}"]`);
  if (item) {
    item.remove();
  }
}

function removeAvailableItemByIndex(index) {
  const cargoItems = document.querySelectorAll('#available-cargo .cargo-item');
  // Find the item that was at the original index when optimization ran
  if (cargoItems[index]) {
    cargoItems[index].remove();
  }
}

// -----------------------------------------------------END UI MANAGEMENT FUNCTIONS---------------------------------------------------------


// -----------------------------------------------------SUIT SYSTEM FUNCTIONS---------------------------------------------------------------

function applySuitConfiguration() {
  const suitType = document.getElementById('suitType').value;
  const config = suitConfigurations[suitType];
  
  if (!config) return;
  
  // Check for cargo that would be lost
  const cargoToLose = [];
  Object.entries(config.slots).forEach(([slot, enabled]) => {
    if (!enabled && currentBodySlotItems[slot] !== null) {
      cargoToLose.push({
        slot: slot,
        item: currentBodySlotItems[slot]
      });
    }
  });
  
  // If cargo would be lost, warn the user
  if (cargoToLose.length > 0) {
    showSuitChangeWarning(cargoToLose, config, suitType);
  } else {
    // No cargo conflicts, apply immediately
    applySuitConfigurationDirect(config);
  }
}

function showSuitChangeWarning(cargoToLose, config, suitType) {
  const cargoList = cargoToLose.map(cargo => 
    `‚Ä¢ ${cargo.item.name} (${cargo.slot.replace(/([A-Z])/g, ' $1').toLowerCase()})`
  ).join('\n');
  
  const message = `‚ö†Ô∏è WARNING: Changing to ${config.name} will remove cargo from restricted slots:\n\n${cargoList}\n\nWhat would you like to do?`;
  
  // Create custom dialog
  const dialogHtml = `
    <div id="suitWarningDialog" style="
      position: fixed; 
      top: 0; left: 0; 
      width: 100%; height: 100%; 
      background-color: rgba(0, 0, 0, 0.8); 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      z-index: 1000;
    ">
      <div style="
        background-color: rgba(42, 42, 42, 0.95); 
        padding: 30px; 
        border-radius: 10px; 
        border: 2px solid #ffaa00;
        max-width: 500px;
        color: white;
        text-align: center;
      ">
        <h3 style="color: #ffaa00; margin-top: 0;">‚ö†Ô∏è Suit Change Warning</h3>
        <p>Changing to <strong>${config.name}</strong> will remove cargo from restricted slots:</p>
        <div style="background-color: rgba(60, 60, 60, 0.8); padding: 15px; margin: 15px 0; border-radius: 6px; text-align: left;">
          ${cargoToLose.map(cargo => 
            `<p style="margin: 5px 0;">‚Ä¢ <strong>${cargo.item.name}</strong> (${cargo.slot.replace(/([A-Z])/g, ' $1').toLowerCase()}) - ${cargo.item.weight}kg, Priority ${cargo.item.priority}</p>`
          ).join('')}
        </div>
        <p style="margin-bottom: 20px;">What would you like to do?</p>
        <div>
          <button onclick="moveCargoToBackpack('${suitType}')" style="
            background-color: #2196F3; 
            color: white; 
            border: none; 
            padding: 10px 15px; 
            margin: 5px; 
            border-radius: 4px; 
            cursor: pointer;
          ">üì¶ Move to Backpack</button>
          <button onclick="moveCargoToAvailable('${suitType}')" style="
            background-color: #4CAF50; 
            color: white; 
            border: none; 
            padding: 10px 15px; 
            margin: 5px; 
            border-radius: 4px; 
            cursor: pointer;
          ">üìã Move to Vicinity</button>
          <button onclick="proceedWithLoss('${suitType}')" style="
            background-color: #ff4444; 
            color: white; 
            border: none; 
            padding: 10px 15px; 
            margin: 5px; 
            border-radius: 4px; 
            cursor: pointer;
          ">üóëÔ∏è Discard Cargo</button>
          <button onclick="cancelSuitChange()" style="
            background-color: #666; 
            color: white; 
            border: none; 
            padding: 10px 15px; 
            margin: 5px; 
            border-radius: 4px; 
            cursor: pointer;
          ">‚ùå Cancel</button>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', dialogHtml);
}

function moveCargoToBackpack(suitType) {
  const config = suitConfigurations[suitType];
  
  // Move restricted cargo to backpack
  Object.entries(config.slots).forEach(([slot, enabled]) => {
    if (!enabled && currentBodySlotItems[slot] !== null) {
      const item = currentBodySlotItems[slot];
      
      // Add to backpack
      currentBackpackItems.push({
        id: Date.now() + Math.random(),
        name: item.name,
        weight: item.weight,
        size: item.size,
        priority: item.priority
      });
      
      // Clear from body slot data AND UI
      currentBodySlotItems[slot] = null;
      clearBodySlotUI(slot);
    }
  });
  
  // Apply suit configuration
  applySuitConfigurationDirect(config);
  
  // Update displays
  renderBackpackItems();
  updateCurrentLoad();
  
  // Close dialog
  closeSuitDialog();
  
  alert('‚úÖ Cargo moved to backpack successfully!');
}

function moveCargoToAvailable(suitType) {
  const config = suitConfigurations[suitType];
  
  // Move restricted cargo to available list
  Object.entries(config.slots).forEach(([slot, enabled]) => {
    if (!enabled && currentBodySlotItems[slot] !== null) {
      const item = currentBodySlotItems[slot];
      
      // Add to available cargo
      const container = document.getElementById('available-cargo');
      const itemId = Date.now() + Math.random();
      const newItem = document.createElement('div');
      newItem.className = 'cargo-item';
      newItem.setAttribute('data-item-id', itemId);
      
      newItem.innerHTML = `
        <label>Item Name: <input type="text" value="${item.name}" /></label>
        <label>Weight: <input type="number" step="0.1" value="${item.weight}" /></label>
        <label>Size: 
          <select class="cargo-size">
            <option value="1" ${item.size === 1 ? 'selected' : ''}>S (1 unit)</option>
            <option value="2" ${item.size === 2 ? 'selected' : ''}>M (2 units)</option>
            <option value="4" ${item.size === 4 ? 'selected' : ''}>L (4 units)</option>
            <option value="6" ${item.size === 6 ? 'selected' : ''}>XL (6 units)</option>
          </select>
        </label>
        <label>Priority: <input type="number" min="1" max="5" value="${item.priority}" /></label>
        <button onclick="removeAvailableItem('${itemId}')" style="background-color: #ff4444;">Remove</button>
      `;
      
      container.appendChild(newItem);
      
      // Clear from body slot data AND UI
      currentBodySlotItems[slot] = null;
      clearBodySlotUI(slot);
    }
  });
  
  // Apply suit configuration
  applySuitConfigurationDirect(config);
  
  // Update displays
  updateCurrentLoad();
  
  // Close dialog
  closeSuitDialog();
  
  alert('‚úÖ Cargo moved to available list successfully!');
}

function proceedWithLoss(suitType) {
  const config = suitConfigurations[suitType];
  
  // Clear restricted cargo (lose it)
  Object.entries(config.slots).forEach(([slot, enabled]) => {
    if (!enabled && currentBodySlotItems[slot] !== null) {
      // Clear from body slot data AND UI
      currentBodySlotItems[slot] = null;
      clearBodySlotUI(slot);
    }
  });
  
  // Apply suit configuration
  applySuitConfigurationDirect(config);
  
  // Update displays
  updateCurrentLoad();
  
  // Close dialog
  closeSuitDialog();
  
  alert('‚ö†Ô∏è Cargo discarded. Suit changed successfully.');
}

function cancelSuitChange() {
  // Revert suit selection to previous value
  // We need to store the previous value when the change starts
  const currentSuit = document.getElementById('suitType').getAttribute('data-previous') || 'standard';
  document.getElementById('suitType').value = currentSuit;
  
  // Close dialog
  closeSuitDialog();
}

function closeSuitDialog() {
  const dialog = document.getElementById('suitWarningDialog');
  if (dialog) {
    dialog.remove();
  }
}

function applySuitConfigurationDirect(config) {
  // Apply slot restrictions
  Object.entries(config.slots).forEach(([slot, enabled]) => {
    const container = document.getElementById(slot + 'Details').parentElement;
    const statusSelect = document.getElementById(slot + 'Status');
    
    if (enabled) {
      container.style.opacity = '1';
      container.style.pointerEvents = 'auto';
      statusSelect.disabled = false;
    } else {
      container.style.opacity = '0.5';
      container.style.pointerEvents = 'none';
      statusSelect.disabled = true;
      
      // Clear disabled slots (if not already cleared by the warning functions)
      if (currentBodySlotItems[slot] !== null) {
        statusSelect.value = '';
        currentBodySlotItems[slot] = null;
        document.getElementById(slot + 'Details').style.display = 'none';
      }
    }
  });
  
  // Update the previous suit value for cancel functionality
  document.getElementById('suitType').setAttribute('data-previous', document.getElementById('suitType').value);
  
  // COMMENT OUT OR REMOVE THIS LINE:
  // updateCurrentLoad();
}

function clearBodySlotUI(slot) {
  // Set status dropdown to empty
  document.getElementById(slot + 'Status').value = '';
  
  // Hide the details section
  document.getElementById(slot + 'Details').style.display = 'none';
  
  // Clear the input fields
  document.getElementById(slot + 'Name').value = '';
  document.getElementById(slot + 'Weight').value = '';
  document.getElementById(slot + 'Priority').value = '';
}

// -----------------------------------------------------END SUIT SYSTEM---------------------------------------------------------------------

//------------------------------------------------------CORE CALCULATION FUNCTIONS----------------------------------------------------------

function updateCurrentLoad() {
  // Calculate totals from backpack items
  const backpackWeight = currentBackpackItems.reduce((sum, item) => sum + (item.weight || 0), 0);
  const backpackSize = currentBackpackItems.reduce((sum, item) => sum + (item.size || 0), 0);
  
  // Calculate totals from body slot items
  const bodySlotWeight = Object.values(currentBodySlotItems)
    .filter(item => item !== null)
    .reduce((sum, item) => sum + (item.weight || 0), 0);
  
  const bodySlotCount = Object.values(currentBodySlotItems).filter(item => item !== null).length;
  
  // Get available body slots based on current suit
  const suitType = document.getElementById('suitType').value;
  const suitConfig = suitConfigurations[suitType] || suitConfigurations['standard'];
  const availableBodySlots = Object.values(suitConfig.slots).filter(enabled => enabled).length;
  
  // Total weight includes both backpack AND body slot items
  const totalWeight = backpackWeight + bodySlotWeight;
  const totalSize = backpackSize + bodySlotCount;
  
  // Update summary display - PROTECT ONLY THE DISPLAY VALUES
  const summary = document.getElementById('current-load-summary');
  summary.innerHTML = `
    <h4>Current Load Summary:</h4>
    <p><strong>Backpack:</strong> ${currentBackpackItems.length} items, ${Math.abs(backpackWeight).toFixed(1)}kg, ${Math.abs(backpackSize)} units</p>
    <p><strong>Body Slots:</strong> ${Math.abs(bodySlotCount)}/${availableBodySlots} occupied, ${Math.abs(bodySlotWeight).toFixed(1)}kg</p>
    <p><strong>Total Weight:</strong> ${Math.abs(totalWeight).toFixed(1)}kg</p>
    <p><strong>Total Size:</strong> ${Math.abs(totalSize)} units</p>
  `;
  
  // Calculate capacity with the correct total weight
  calculateCarryingCapacity(totalWeight, backpackSize, bodySlotCount);
}

function calculateCarryingCapacity(totalWeight, backpackSize, bodySlotCount) {
  // Get suit configuration
  const suitType = document.getElementById('suitType').value;
  const suitConfig = suitConfigurations[suitType] || suitConfigurations['standard'];
  
  // Calculate available body slots based on suit
  const availableBodySlots = Object.values(suitConfig.slots).filter(enabled => enabled).length;
  
  // Calculate weight capacity
  const baseCapacity = Math.abs(parseInt(document.getElementById('baseCapacity').value)) || 120;
  const gearWeight = Math.abs(parseFloat(document.getElementById('gearWeight').value)) || 0;
  const chiraliumCrystals = Math.abs(parseInt(document.getElementById('chiraliumCrystals').value)) || 0;
  const chiraliumBoost = Math.min(50, Math.floor(chiraliumCrystals / 1000 * 10) / 10); // Capped at 50kg
  const safetyBuffer = parseFloat(document.getElementById('safetyBuffer').value);
  
  // UPDATED: Subtract suit weight instead of adding bonus
  const actualMaxWeight = baseCapacity - suitConfig.weight - gearWeight + chiraliumBoost;
  const effectiveMaxWeight = actualMaxWeight - safetyBuffer;
  
  // Use the passed parameters
  const remainingWeight = effectiveMaxWeight - (totalWeight || 0);
  const remainingBackpackSpace = 28 - (backpackSize || 0);
  const remainingBodySlots = availableBodySlots - (bodySlotCount || 0);
  
  // Update displays
  document.getElementById('suit-bonus').innerHTML = 
    `Suit Weight: -${suitConfig.weight}kg (${suitConfig.name})`;
  
  document.getElementById('chiralium-boost').innerHTML = 
    `Chiralium Boost: +${chiraliumBoost.toFixed(1)}kg (${chiraliumCrystals} crystals)`;
  
  document.getElementById('effective-capacity').innerHTML = 
    `Safe Carrying Capacity: ${effectiveMaxWeight.toFixed(1)}kg (${safetyBuffer}kg buffer)`;
  
  // Update load status with buffer consideration
  let statusColor = '#4CAF50';
  let statusText = 'Light Load';
  
  if (remainingWeight < 1) {
    statusColor = '#ff4444';
    statusText = 'Near Safe Limit!';
  } else if (remainingWeight < 5) {
    statusColor = '#ffaa00';
    statusText = 'Heavy Load';
  }
  
  // Add capacity status to summary
  const summary = document.getElementById('current-load-summary');
  summary.innerHTML += `
    <p><span style="color: ${statusColor}"><strong>Status:</strong> ${statusText}</span></p>
    <p><strong>Safe Remaining:</strong> ${remainingWeight.toFixed(1)}kg weight</p>
    <p><strong>Buffer Applied:</strong> ${safetyBuffer}kg safety margin</p>
    <p><strong>Absolute Max:</strong> ${Math.abs(actualMaxWeight).toFixed(1)}kg total capacity</p>
    <p><strong>Space Remaining:</strong> ${remainingBackpackSpace} backpack units, ${remainingBodySlots}/${availableBodySlots} body slots</p>
  `;
}

function getRemainingCapacity() {
  // Calculate current load
  const backpackWeight = currentBackpackItems.reduce((sum, item) => sum + (item.weight || 0), 0);
  const backpackSize = currentBackpackItems.reduce((sum, item) => sum + (item.size || 0), 0);
  const bodySlotWeight = Object.values(currentBodySlotItems)
    .filter(item => item !== null)
    .reduce((sum, item) => sum + (item.weight || 0), 0);
  const bodySlotCount = Object.values(currentBodySlotItems).filter(item => item !== null).length;
  
  // Calculate capacity with suit weight
  const suitType = document.getElementById('suitType').value;
  const suitConfig = suitConfigurations[suitType] || suitConfigurations['standard'];
  const baseCapacity = Math.abs(parseInt(document.getElementById('baseCapacity').value)) || 120;
  const gearWeight = Math.abs(parseFloat(document.getElementById('gearWeight').value)) || 0;
  const chiraliumCrystals = Math.abs(parseInt(document.getElementById('chiraliumCrystals').value)) || 0;
  const chiraliumBoost = Math.min(50, Math.floor(chiraliumCrystals / 1000 * 10) / 10);
  
  // UPDATED: Subtract suit weight instead of adding bonus
  const maxWeight = baseCapacity - suitConfig.weight - gearWeight + chiraliumBoost;
  const maxBackpackSize = 28;
  
  // Calculate available body slots based on suit
  const availableBodySlots = Object.values(suitConfig.slots).filter(enabled => enabled).length;
  
  // Apply safety buffer
  const safetyBuffer = parseFloat(document.getElementById('safetyBuffer').value);
  const effectiveMaxWeight = maxWeight - safetyBuffer;
  
  return {
    remainingWeight: effectiveMaxWeight - (backpackWeight + bodySlotWeight),
    remainingBackpackSize: maxBackpackSize - backpackSize,
    remainingBodySlots: availableBodySlots - bodySlotCount,
    actualMaxWeight: maxWeight,
    effectiveMaxWeight: effectiveMaxWeight,
    safetyBuffer: safetyBuffer
  };
}

//------------------------------------------------------END CORE CALCULATION FUNCTIONS-------------------------------------------------------


//------------------------------------------------------OPTIMIZATION FUNCTIONS---------------------------------------------------------------

function toggleStrategyOptions() {
  const algorithm = document.getElementById('algorithmChoice').value;
  const greedyOptions = document.getElementById('greedyOptions');
  
  if (algorithm === 'dynamic') {
    greedyOptions.style.display = 'none';
  } else {
    greedyOptions.style.display = 'block';
  }
}

function optimizeCargo() {
  const algorithm = document.getElementById('algorithmChoice').value;
  const availableItems = getAvailableCargoItems();
  
  if (availableItems.length === 0) {
    document.getElementById('results').innerHTML = '<p style="color: #ff4444;">No available cargo items to optimize!</p>';
    return;
  }
  
  // Calculate remaining capacity
  const capacity = getRemainingCapacity();
  
  // Record start time for performance comparison
  const startTime = performance.now();
  
  let results = [];
  
  if (algorithm === 'greedy') {
    const strategy = document.getElementById('greedyStrategy').value;
    const result = greedyOptimization(availableItems, capacity, strategy);
    result.executionTime = performance.now() - startTime;
    result.algorithm = 'Greedy';
    results = [result];
  } else if (algorithm === 'dynamic') {
    const result = dynamicOptimization(availableItems, capacity);
    result.executionTime = performance.now() - startTime;
    result.algorithm = 'Dynamic Programming';
    results = [result];
  } else if (algorithm === 'compare') {
    const strategy = document.getElementById('greedyStrategy').value;
    
    const greedyStart = performance.now();
    const greedyResult = greedyOptimization(availableItems, capacity, strategy);
    greedyResult.executionTime = performance.now() - greedyStart;
    greedyResult.algorithm = 'Greedy';
    
    const dynamicStart = performance.now();
    const dynamicResult = dynamicOptimization(availableItems, capacity);
    dynamicResult.executionTime = performance.now() - dynamicStart;
    dynamicResult.algorithm = 'Dynamic Programming';
    
    results = [greedyResult, dynamicResult];
  }
  
  // Display results
  displayOptimizationResults(results);
}

function getAvailableCargoItems() {
  const items = [];
  const cargoItems = document.querySelectorAll('#available-cargo .cargo-item');
  
  cargoItems.forEach((item, index) => {
    const name = item.querySelector('input[type="text"]').value || `Item ${index + 1}`;
    const weight = parseFloat(item.querySelector('input[type="number"]').value) || 0;
    const size = parseInt(item.querySelector('.cargo-size').value) || 1;
    const priority = parseInt(item.querySelector('input[min="1"]').value) || 3;
    
    if (weight > 0) { // Only include items with weight
      items.push({ name, weight, size, priority, index });
    }
  });
  
  return items;
}

function greedyOptimization(items, capacity, strategy) {
  // Sort items based on strategy
  let sortedItems = [...items];
  
  switch (strategy) {
    case 'value-weight':
      sortedItems.sort((a, b) => (b.priority / b.weight) - (a.priority / a.weight));
      break;
    case 'priority-first':
      sortedItems.sort((a, b) => {
        if (b.priority !== a.priority) return b.priority - a.priority;
        return (b.priority / b.weight) - (a.priority / a.weight); // Tiebreaker
      });
      break;
    case 'size-efficiency':
      sortedItems.sort((a, b) => (b.priority / b.size) - (a.priority / a.size));
      break;
  }
  
  const selected = [];
  let currentWeight = 0;
  let currentBackpackSize = 0;
  let currentBodySlots = 0;
  
  for (const item of sortedItems) {
    const fitsWeight = currentWeight + item.weight <= capacity.remainingWeight;
    const fitsBackpack = item.size === 1 ? 
      (currentBodySlots < capacity.remainingBodySlots || currentBackpackSize + item.size <= capacity.remainingBackpackSize) :
      currentBackpackSize + item.size <= capacity.remainingBackpackSize;
    
    if (fitsWeight && fitsBackpack) {
      selected.push(item);
      currentWeight += item.weight;
      
      if (item.size === 1 && currentBodySlots < capacity.remainingBodySlots) {
        currentBodySlots++;
      } else {
        currentBackpackSize += item.size;
      }
    }
  }
  
  return {
    items: selected,
    totalWeight: currentWeight,
    totalSize: currentBackpackSize + currentBodySlots,
    strategy: strategy
  };
}

function dynamicOptimization(items, capacity) {
  const n = items.length;
  const maxWeight = Math.floor(capacity.remainingWeight * 10); // Convert to tenths for precision
  const maxSize = capacity.remainingBackpackSize + capacity.remainingBodySlots;
  
  // Handle edge cases
  if (n === 0 || maxWeight <= 0 || maxSize <= 0) {
    return {
      items: [],
      totalWeight: 0,
      totalSize: 0,
      totalValue: 0,
      algorithm: 'Dynamic Programming'
    };
  }
  
  // Create 3D DP table: [item][weight][size] = max value
  const dp = Array(n + 1).fill(null).map(() => 
    Array(maxWeight + 1).fill(null).map(() => 
      Array(maxSize + 1).fill(0)
    )
  );
  
  // Fill the DP table
  for (let i = 1; i <= n; i++) {
    const item = items[i - 1];
    const itemWeight = Math.floor(item.weight * 10); // Convert to tenths
    const itemSize = item.size;
    const itemValue = item.priority;
    
    for (let w = 0; w <= maxWeight; w++) {
      for (let s = 0; s <= maxSize; s++) {
        // Don't take the item
        dp[i][w][s] = dp[i - 1][w][s];
        
        // Take the item if it fits
        if (w >= itemWeight && s >= itemSize) {
          const withItem = dp[i - 1][w - itemWeight][s - itemSize] + itemValue;
          dp[i][w][s] = Math.max(dp[i][w][s], withItem);
        }
      }
    }
  }
  
  // Backtrack to find selected items
  const selectedItems = [];
  let w = maxWeight;
  let s = maxSize;
  
  for (let i = n; i >= 1; i--) {
    if (dp[i][w][s] !== dp[i - 1][w][s]) {
      // This item was selected
      const item = items[i - 1];
      selectedItems.push(item);
      w -= Math.floor(item.weight * 10);
      s -= item.size;
    }
  }
  
  // Calculate totals
  const totalWeight = selectedItems.reduce((sum, item) => sum + item.weight, 0);
  const totalSize = selectedItems.reduce((sum, item) => sum + item.size, 0);
  const totalValue = selectedItems.reduce((sum, item) => sum + item.priority, 0);
  
  return {
    items: selectedItems,
    totalWeight: totalWeight,
    totalSize: totalSize,
    totalValue: totalValue,
    algorithm: 'Dynamic Programming'
  };
}

function displayOptimizationResults(results) {
  if (!Array.isArray(results)) {
    results = [results];
  }
  
  let html = '';
  
  results.forEach((result, index) => {
    const bgColor = index === 0 ? 'rgba(60, 60, 60, 0.9)' : 'rgba(40, 80, 40, 0.9)';
    
    html += `
      <div style="background-color: ${bgColor}; padding: 15px; margin: 10px 0; border-radius: 6px;">
        <h4>${result.algorithm} Results</h4>
        <p><strong>Selected ${result.items.length} items:</strong></p>
        <ul>
    `;
    
    result.items.forEach(item => {
      const sizeLabel = item.size === 1 ? 'S' : item.size === 2 ? 'M' : item.size === 4 ? 'L' : 'XL';
      html += `<li>${item.name} - ${item.weight}kg, ${sizeLabel}, Priority ${item.priority}</li>`;
    });
    
    const totalValue = result.totalValue || result.items.reduce((sum, item) => sum + item.priority, 0);
    
    html += `
        </ul>
        <p><strong>Total:</strong> ${result.totalWeight.toFixed(1)}kg, ${result.totalSize} units, ${totalValue} priority points</p>
        <p><strong>Execution Time:</strong> ${result.executionTime.toFixed(2)}ms</p>
      </div>
    `;
  });
  
  // Add comparison if multiple results
  if (results.length > 1) {
    const greedyResult = results.find(r => r.algorithm === 'Greedy');
    const dynamicResult = results.find(r => r.algorithm === 'Dynamic Programming');
    
    if (greedyResult && dynamicResult) {
      const valueDiff = dynamicResult.totalValue - greedyResult.totalValue;
      const timeDiff = dynamicResult.executionTime - greedyResult.executionTime;
      
      html += `
        <div style="background-color: rgba(255, 165, 0, 0.2); padding: 15px; margin: 10px 0; border-radius: 6px; border: 2px solid #ffaa00;">
          <h4>üìä Comparison</h4>
          <p><strong>Value Difference:</strong> Dynamic Programming found ${valueDiff > 0 ? '+' + valueDiff : valueDiff} more priority points</p>
          <p><strong>Speed Difference:</strong> Greedy was ${timeDiff.toFixed(2)}ms faster</p>
          <p><strong>Efficiency:</strong> ${valueDiff > 0 ? 'Dynamic Programming found a better solution!' : 'Both algorithms found the same optimal solution!'}</p>
        </div>
      `;
    }
  }
  
  // Add apply button for single results or best result for comparisons
  const bestResult = results.length === 1 ? results[0] : 
    results.reduce((best, current) => 
      (current.totalValue || current.items.reduce((sum, item) => sum + item.priority, 0)) > 
      (best.totalValue || best.items.reduce((sum, item) => sum + item.priority, 0)) ? current : best
    );
  
  html += `
    <div style="margin-top: 15px;">
      <button onclick="applyOptimization()" style="background-color: #2196F3; margin-right: 10px;">
        üì¶ Apply ${bestResult.algorithm} Results
      </button>
      <button onclick="clearResults()" style="background-color: #666;">
        Clear Results
      </button>
    </div>
  `;
  
  document.getElementById('results').innerHTML = html;
  
  // Store the best result for applying
  window.lastOptimizationResult = bestResult;
}

function applyOptimization() {
  if (!window.lastOptimizationResult) {
    alert('No optimization results to apply!');
    return;
  }
  
  const result = window.lastOptimizationResult;
  
  // Sort items by index in descending order to remove from end first
  const sortedItems = [...result.items].sort((a, b) => b.index - a.index);
  
  // Add items to backpack and body slots
  result.items.forEach(item => {
    if (item.size === 1) {
      // Try to place S items in body slots first
      if (!addToBodySlot(item)) {
        // If body slots full, add to backpack
        addToBackpack(item);
      }
    } else {
      // M, L, XL items go to backpack
      addToBackpack(item);
    }
  });
  
  // Remove items from available cargo (in reverse order)
  sortedItems.forEach(item => {
    removeAvailableItemByIndex(item.index);
  });
  
  // Update the display
  renderBackpackItems();
  updateCurrentLoad();
  
  // Show confirmation
  document.getElementById('results').innerHTML += `
    <p style="color: #4CAF50; margin-top: 10px;">
      ‚úÖ Optimization applied! ${result.items.length} items added to Sam's load and removed from available cargo.
    </p>
  `;
}

function addToBodySlot(item) {
  const slots = ['leftArm', 'rightArm', 'leftLeg', 'rightLeg'];
  
  // Get current suit configuration
  const suitType = document.getElementById('suitType').value;
  const suitConfig = suitConfigurations[suitType] || suitConfigurations['standard'];
  
  for (const slot of slots) {
    // Check if slot is enabled by current suit AND empty
    if (suitConfig.slots[slot] && currentBodySlotItems[slot] === null) {
      // Set the dropdown to occupied
      document.getElementById(slot + 'Status').value = 'occupied';
      
      // Show the input fields
      document.getElementById(slot + 'Details').style.display = 'block';
      
      // Fill in the item data
      document.getElementById(slot + 'Name').value = item.name;
      document.getElementById(slot + 'Weight').value = item.weight;
      document.getElementById(slot + 'Priority').value = item.priority;
      
      // Update the data structure
      currentBodySlotItems[slot] = {
        name: item.name,
        weight: item.weight,
        size: 1,
        priority: item.priority
      };
      
      return true; // Successfully placed
    }
  }
  
  return false; // No available slots (either disabled by suit or occupied)
}

function addToBackpack(item) {
  const newItem = {
    id: Date.now() + Math.random(), // Unique ID
    name: item.name,
    weight: item.weight,
    size: item.size,
    priority: item.priority
  };
  
  currentBackpackItems.push(newItem);
}

function clearResults() {
  document.getElementById('results').innerHTML = '';
  window.lastOptimizationResult = null;
}

//------------------------------------------------------END OPTIMIZATION FUNCTIONS-----------------------------------------------------------


//------------------------------------------------------SAVE/LOAD FUNCTIONS------------------------------------------------------------------

// Auto-save functionality
function autoSave() {
  const gameState = createGameState();
  localStorage.setItem('cargoOptimizer_autoSave', JSON.stringify(gameState));
  
  // Update last saved timestamp
  const now = new Date().toLocaleTimeString();
  document.getElementById('lastSaved').textContent = now;
}

// Create game state object (used by both auto-save and manual save)
function createGameState() {
  return {
    version: "1.0",
    samStatus: {
      baseCapacity: document.getElementById('baseCapacity').value,
      gearWeight: document.getElementById('gearWeight').value,
      chiraliumCrystals: document.getElementById('chiraliumCrystals').value
    },
    currentBackpackItems: currentBackpackItems,
    currentBodySlotItems: currentBodySlotItems,
    availableCargo: getAvailableCargoItems(),
    timestamp: new Date().toISOString(),
    metadata: {
      totalItems: currentBackpackItems.length,
      bodySlotCount: Object.values(currentBodySlotItems).filter(item => item !== null).length
    }
  };
}

// Load game state from parsed JSON
function loadGameState(gameState) {
  // Restore Sam's status
  if (gameState.samStatus) {
    document.getElementById('baseCapacity').value = gameState.samStatus.baseCapacity || 120;
    document.getElementById('gearWeight').value = gameState.samStatus.gearWeight || 0;
    document.getElementById('chiraliumCrystals').value = gameState.samStatus.chiraliumCrystals || 0;
  }
  
  // Restore backpack items
  currentBackpackItems = gameState.currentBackpackItems || [];
  
  // Restore body slot items
  currentBodySlotItems = gameState.currentBodySlotItems || {
    leftArm: null,
    rightArm: null,
    leftLeg: null,
    rightLeg: null
  };
  
  // Restore body slot UI
  restoreBodySlots();
  
  // Restore available cargo
  if (gameState.availableCargo) {
    restoreAvailableCargo(gameState.availableCargo);
  }
  
  // Update all displays
  renderBackpackItems();
  updateCurrentLoad();
}

// Save to numbered slot
function saveToSlot(slotNumber) {
  const gameState = createGameState();
  const slotKey = `cargoOptimizer_slot${slotNumber}`;
  
  localStorage.setItem(slotKey, JSON.stringify(gameState));
  
  // Visual feedback
  const button = event.target;
  const originalText = button.textContent;
  button.textContent = '‚úÖ Saved!';
  button.style.backgroundColor = '#4CAF50';
  
  setTimeout(() => {
    button.textContent = originalText;
    button.style.backgroundColor = '';
  }, 1000);
  
  console.log(`Game saved to slot ${slotNumber}`);
}

// Load from numbered slot
function loadFromSlot(slotNumber) {
  const slotKey = `cargoOptimizer_slot${slotNumber}`;
  const savedState = localStorage.getItem(slotKey);
  
  if (savedState) {
    try {
      const gameState = JSON.parse(savedState);
      loadGameState(gameState);
      
      // Visual feedback
      const button = event.target;
      const originalText = button.textContent;
      button.textContent = '‚úÖ Loaded!';
      button.style.backgroundColor = '#2196F3';
      
      setTimeout(() => {
        button.textContent = originalText;
        button.style.backgroundColor = '';
      }, 1000);
      
      console.log(`Game loaded from slot ${slotNumber}`);
    } catch (error) {
      alert(`Error loading from slot ${slotNumber}: ${error.message}`);
    }
  } else {
    alert(`No save data found in slot ${slotNumber}`);
  }
}

// Load auto-save on page load
function loadAutoSave() {
  const autoSaveData = localStorage.getItem('cargoOptimizer_autoSave');
  if (autoSaveData) {
    try {
      const gameState = JSON.parse(autoSaveData);
      loadGameState(gameState);
      
      // Update last saved display
      const savedTime = new Date(gameState.timestamp).toLocaleTimeString();
      document.getElementById('lastSaved').textContent = savedTime;
      
      console.log('Auto-save loaded successfully');
    } catch (error) {
      console.error('Error loading auto-save:', error);
    }
  }
}

// Download current state as JSON file
function downloadSaveFile() {
  const gameState = {
    version: "1.0", // For future compatibility
    samStatus: {
      baseCapacity: document.getElementById('baseCapacity').value,
      gearWeight: document.getElementById('gearWeight').value,
      chiraliumCrystals: document.getElementById('chiraliumCrystals').value
    },
    currentBackpackItems: currentBackpackItems,
    currentBodySlotItems: currentBodySlotItems,
    availableCargo: getAvailableCargoItems(),
    timestamp: new Date().toISOString(),
    metadata: {
      totalItems: currentBackpackItems.length,
      bodySlotCount: Object.values(currentBodySlotItems).filter(item => item !== null).length
    }
  };
  
  const dataStr = JSON.stringify(gameState, null, 2);
  const dataBlob = new Blob([dataStr], {type: 'application/json'});
  
  const link = document.createElement('a');
  link.href = URL.createObjectURL(dataBlob);
  link.download = `cargo-optimizer-${new Date().toISOString().split('T')[0]}.json`;
  link.click();
  
  // Clean up
  URL.revokeObjectURL(link.href);
  
  console.log('Save file downloaded!');
}

// Upload and load JSON file
function uploadSaveFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const gameState = JSON.parse(e.target.result);
      loadGameState(gameState);
      alert(`Save file loaded successfully!\nLoaded: ${gameState.metadata?.totalItems || 0} backpack items, ${gameState.metadata?.bodySlotCount || 0} body slot items`);
    } catch (error) {
      alert('Error loading save file: ' + error.message);
      console.error('Save file error:', error);
    }
  };
  reader.readAsText(file);
  
  // Clear the file input so the same file can be loaded again
  event.target.value = '';
}

// Restore body slot UI elements
function restoreBodySlots() {
  const slots = ['leftArm', 'rightArm', 'leftLeg', 'rightLeg'];
  
  slots.forEach(slot => {
    const item = currentBodySlotItems[slot];
    const statusSelect = document.getElementById(slot + 'Status');
    const detailsDiv = document.getElementById(slot + 'Details');
    
    if (item) {
      statusSelect.value = 'occupied';
      detailsDiv.style.display = 'block';
      document.getElementById(slot + 'Name').value = item.name || '';
      document.getElementById(slot + 'Weight').value = item.weight || 0;
      document.getElementById(slot + 'Priority').value = item.priority || 3;
    } else {
      statusSelect.value = '';
      detailsDiv.style.display = 'none';
      document.getElementById(slot + 'Name').value = '';
      document.getElementById(slot + 'Weight').value = '';
      document.getElementById(slot + 'Priority').value = '';
    }
  });
}

// Restore available cargo items
function restoreAvailableCargo(availableItems) {
  // Clear existing available cargo
  const container = document.getElementById('available-cargo');
  container.innerHTML = '';
  
  // Add each saved item
  availableItems.forEach(item => {
    const itemDiv = document.createElement('div');
    itemDiv.className = 'cargo-item';
    const itemId = Date.now() + Math.random();
    itemDiv.setAttribute('data-item-id', itemId);
    
    itemDiv.innerHTML = `
      <label>Item Name: <input type="text" value="${item.name || ''}" /></label>
      <label>Weight: <input type="number" step="0.1" value="${item.weight || 0}" /></label>
      <label>Size: 
        <select class="cargo-size">
          <option value="1" ${item.size === 1 ? 'selected' : ''}>S (1 unit)</option>
          <option value="2" ${item.size === 2 ? 'selected' : ''}>M (2 units)</option>
          <option value="4" ${item.size === 4 ? 'selected' : ''}>L (4 units)</option>
          <option value="6" ${item.size === 6 ? 'selected' : ''}>XL (6 units)</option>
        </select>
      </label>
      <label>Priority: <input type="number" min="1" max="5" value="${item.priority || 3}" /></label>
      <button onclick="removeAvailableItem('${itemId}')" style="background-color: #ff4444;">Remove</button>
    `;
    
    container.appendChild(itemDiv);
  });
}

function clearAllData() {
  if (confirm('Are you sure you want to clear all data? This will also clear auto-save and all save slots.')) {
    // Clear all arrays
    currentBackpackItems = [];
    currentBodySlotItems = {
      leftArm: null,
      rightArm: null,
      leftLeg: null,
      rightLeg: null
    };
    
    // Reset form values
    document.getElementById('baseCapacity').value = 120;
    document.getElementById('gearWeight').value = 0;
    document.getElementById('chiraliumCrystals').value = 0;
    document.getElementById('suitType').value = 'standard';
    document.getElementById('safetyBuffer').value = '0.1';
    
    // Clear available cargo
    document.getElementById('available-cargo').innerHTML = '';
    
    // Clear results
    document.getElementById('results').innerHTML = '';
    
    // Reset body slots
    restoreBodySlots();
    
    // Clear localStorage
    localStorage.removeItem('cargoOptimizer_autoSave');
    localStorage.removeItem('cargoOptimizer_slot1');
    localStorage.removeItem('cargoOptimizer_slot2');
    localStorage.removeItem('cargoOptimizer_slot3');
    
    // Reset last saved display
    document.getElementById('lastSaved').textContent = 'Never';
    
    // Apply suit configuration after reset
    applySuitConfiguration();
    
    // Update displays
    renderBackpackItems();
    updateCurrentLoad();
    
    alert('All data cleared!');
  }
}

//------------------------------------------------------END SAVE/LOAD FUNCTIONS---------------------------------------------------------------


//------------------------------------------------------INPUT VALIDATION FUNCTIONS------------------------------------------------------------

function validateNumberInput(input) {
  const min = parseInt(input.min);
  const max = parseInt(input.max);
  let value = parseInt(input.value);
  
  // Handle empty or invalid input
  if (isNaN(value)) {
    if (input.placeholder) {
      value = parseInt(input.placeholder) || min;
    } else {
      value = min;
    }
  }
  
  // Clamp to valid range
  if (value < min) value = min;
  if (value > max) value = max;
  
  // Update the input field
  input.value = value;
  
  // Trigger any change handlers
  input.dispatchEvent(new Event('input', { bubbles: true }));
}



//------------------------------------------------------END INPUT VALIDATION FUNCTIONS--------------------------------------------------------


//---------------------------------------------------EVENT LISTENERS---------------------------------------------------

// Suit type change tracking (for cancel functionality)
document.getElementById('suitType').addEventListener('change', function() {
  // Store current value as previous before change
  if (!this.hasAttribute('data-previous')) {
    this.setAttribute('data-previous', 'standard');
  } else {
    this.setAttribute('data-previous', this.value);
  }
});

// Auto-save on input changes
document.addEventListener('input', function() {
  updateCurrentLoad();
  autoSave();
});

// Input validation on blur
document.addEventListener('blur', function(e) {
  if (e.target.type === 'number') {
    // Handle min/max range validation
    if (e.target.min && e.target.max) {
      validateNumberInput(e.target);
    }
    
    // Handle negative to positive conversion for weight/crystal inputs
    const isWeightOrCrystalInput = e.target.step === "0.1" || 
                                   e.target.id === "chiraliumCrystals" || 
                                   e.target.id === "baseCapacity" ||
                                   e.target.id === "gearWeight";
    
    if (isWeightOrCrystalInput) {
      let value = parseFloat(e.target.value);
      if (!isNaN(value) && value < 0) {
        e.target.value = Math.abs(value);
        // Trigger change event to update calculations
        e.target.dispatchEvent(new Event('change', { bubbles: true }));
      }
    }
  }
}, true);

// Input validation on change
document.addEventListener('change', function(e) {
  if (e.target.type === 'number' && e.target.min && e.target.max) {
    validateNumberInput(e.target);
  }
});

// Page initialization
window.addEventListener('load', function() {
  document.getElementById('suitType').setAttribute('data-previous', 'standard');
  updateCurrentLoad();
  loadAutoSave();
});

</script> 