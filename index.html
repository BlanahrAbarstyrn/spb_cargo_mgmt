<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Sam Porter Bridges Cargo Optimizer</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.1)),
                  url('../assets/ladderoverchasm.jpg') center/cover fixed;
      color: #ffffff;
      min-height: 100vh;
    }

    .parent-container {
      display: flex;
      flex-wrap: wrap;
      padding: 10px;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      box-sizing: border-box;
    }

    .child-container-slim {
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 350px;
      gap: 10px;
      padding: 10px;
    }

    .child-container-wide {
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 750px;
      gap: 10px;
      padding: 10px;
    }
    
    .content {
      min-height: 200px;
      padding: 10px;
      position: relative;
      width: 100%;
      z-index: 1;
    }
    
    h1 {
      color: #4CAF50;
      font-size: 48px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
    }
    
    .section {
      background-color: rgba(42, 42, 42, 0.6);
      padding: 20px;
      margin: 15px 0;
      border-radius: 8px;
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    h2, h3, h4 {
      color: #ffffff;
      margin-top: 0;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
    }
    
    .load-container {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }

    .body-slots-container {
      flex: 1;
      min-width: 300px;
    }

    .backpack-container {
      flex: 1;
      min-width: 300px;
    }

    /* On very narrow screens, make them stack */
    @media (max-width: 650px) {
      .load-container {
        flex-direction: column;
      }
  
      .body-slots-container,
      .backpack-container {
        min-width: 100%;
      }
    }

    input, select {
      background-color: rgba(51, 51, 51, 0.9);
      color: white;
      border: 1px solid #555;
      padding: 8px;
      margin: 5px;
      border-radius: 4px;
    }
    
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
      margin: 5px;
    }
    
    button:hover {
      background-color: #45a049;
    }
    
    .cargo-item {
      background-color: rgba(60, 60, 60, 0.7);
      padding: 15px;
      margin: 10px 0;
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .body-slot {
      margin: 10px 0;
    }
    
    label {
      display: block;
      margin: 8px 0;
    }
  </style>
</head>

<body>
  <div class="parent-container">
    <div class="content">
      <h1>Sam Porter Bridges Cargo Optimizer</h1>
      <p>Keep on keeping on! üì¶ --- created for the original Death Stranding video game</p>
      <p>Image credit: „Çπ„Éº„Éë„ÉºÂàùÂøÉËÄÖ Super Newb</p>
    </div>

    <div class="child-container-slim">
      <div class="section">
        <h2>Sam's Status</h2>
        <label>Base Carrying Capacity: <input type="number" id="baseCapacity" value="125" /></label>
        <label>Current Gear Weight: <input type="number" step="0.1" id="gearWeight" value="0" placeholder="Boots, suit, tools..." /></label>
        <label>Chiralium Crystals: <input type="number" id="chiraliumCrystals" value="0" placeholder="Total crystals carried" /></label>
        <div id="chiralium-boost" style="margin-top: 5px; color: #00ccff;"></div>
        <div id="effective-capacity" style="margin-top: 10px; margin-bottom: 60px; font-weight: bold; color: #4CAF50;"></div>
      </div>

      <div class="section">
        <h2>Priority Legend</h2>
        <p>5 => Story-critical</p>
        <p>4 => Sam's Orders</p>
        <p>3 => Standard Orders</p>
        <p>2 => Location: Facilities on the way or already a destination</p>
        <p>1 => High Rewards/Likes for recovery</p>
        <h5>* This list is just a suggestion. Optimization will be based on how each piece of cargo is rated. Or leave all cargo set to default "3" to ignore priority during optimization.</h5>
      </div>
    </div>

    <div class="child-container-wide">
      <div class="section">
        <h2>Sam's Current Load</h2>
          <div id="current-load-summary" style="margin-top: 15px; padding: 10px; background-color: rgba(60, 60, 60, 0.8); border-radius: 6px;">
            <!-- Load summary will be displayed here -->
          </div>
        </div>

      <div class="section">
        <div class="load-container">
          <div class="body-slots-container">
            <h3>Attached to Suit (S items only)</h3>
            <div id="body-slot-items">
            <div class="body-slot">
              <label>Left Arm:</label>
              <div class="cargo-item">
                <label>Status: 
                  <select id="leftArmStatus" onchange="toggleBodySlot('leftArm')">
                    <option value="">Empty</option>
                    <option value="occupied">S Item (1 unit)</option>
                  </select>
                </label>
                <div id="leftArmDetails" style="display: none;">
                  <label>Name: <input type="text" id="leftArmName" placeholder="Item name" onchange="updateBodySlot('leftArm')" /></label>
                  <label>Weight: <input type="number" step="0.1" id="leftArmWeight" placeholder="5.0" onchange="updateBodySlot('leftArm')" /></label>
                  <label>Priority: <input type="number" min="1" max="5" id="leftArmPriority" placeholder="3" onchange="updateBodySlot('leftArm')" /></label>
                </div>
              </div>
            </div>
        
          <div class="body-slot">
            <label>Right Arm:</label>
            <div class="cargo-item">
              <label>Status: 
                <select id="rightArmStatus" onchange="toggleBodySlot('rightArm')">
                  <option value="">Empty</option>
                  <option value="occupied">S Item (1 unit)</option>
                </select>
              </label>
              <div id="rightArmDetails" style="display: none;">
                <label>Name: <input type="text" id="rightArmName" placeholder="Item name" onchange="updateBodySlot('rightArm')" /></label>
                <label>Weight: <input type="number" step="0.1" id="rightArmWeight" placeholder="5.0" onchange="updateBodySlot('rightArm')" /></label>
                <label>Priority: <input type="number" min="1" max="5" id="rightArmPriority" placeholder="3" onchange="updateBodySlot('rightArm')" /></label>
              </div>
            </div>
          </div>
    
          <div class="body-slot">
            <label>Left Leg:</label>
            <div class="cargo-item">
              <label>Status: 
                <select id="leftLegStatus" onchange="toggleBodySlot('leftLeg')">
                  <option value="">Empty</option>
                  <option value="occupied">S Item (1 unit)</option>
                </select>
              </label>
              <div id="leftLegDetails" style="display: none;">
                <label>Name: <input type="text" id="leftLegName" placeholder="Item name" onchange="updateBodySlot('leftLeg')" /></label>
                <label>Weight: <input type="number" step="0.1" id="leftLegWeight" placeholder="5.0" onchange="updateBodySlot('leftLeg')" /></label>
                <label>Priority: <input type="number" min="1" max="5" id="leftLegPriority" placeholder="3" onchange="updateBodySlot('leftLeg')" /></label>
              </div>
            </div>
          </div>
    
          <div class="body-slot">
            <label>Right Leg:</label>
            <div class="cargo-item">
              <label>Status: 
                <select id="rightLegStatus" onchange="toggleBodySlot('rightLeg')">
                  <option value="">Empty</option>
                  <option value="occupied">S Item (1 unit)</option>
                </select>
              </label>
              <div id="rightLegDetails" style="display: none;">
                <label>Name: <input type="text" id="rightLegName" placeholder="Item name" onchange="updateBodySlot('rightLeg')" /></label>
                <label>Weight: <input type="number" step="0.1" id="rightLegWeight" placeholder="5.0" onchange="updateBodySlot('rightLeg')" /></label>
                <label>Priority: <input type="number" min="1" max="5" id="rightLegPriority" placeholder="3" onchange="updateBodySlot('rightLeg')" /></label>
              </div>
            </div>
          </div>
        </div>
      </div>

        
          <div class="backpack-container">
            <h3>Carried on Back</h3>
            <div id="backpack-items">
              <!-- Individual backpack items will be listed here -->
            </div>
            <button onclick="addBackpackItem()">Add Item to Back</button>
          </div>
        </div>
      </div>
    </div>

      <div class="child-container-slim">
        <div class="section">
          <h2>Cargo in Vicinity</h2>
          <div id="available-cargo">
        </div>
          <button onclick="addCargoItem()">Add Another Available Item</button>
      </div>
    </div>
      <div class="child-container-wide">
        <div class="section">
          <h2>Optimization</h2>
          <div style="margin-bottom: 15px;">
            <label>Greedy Strategy: 
              <select id="greedyStrategy">
                <option value="value-weight">Value/Weight Ratio - Maximum efficiency</option>
                <option value="priority-first">Priority First - Urgent deliveries</option>
                <option value="size-efficiency">Size Efficiency - Fit more items</option>
              </select>
            </label>
          </div>
          <button onclick="optimizeCargo()">üéØ Optimize Load (Greedy)</button>
          <div id="results" style="margin-top: 15px;"></div>
        </div>
        <div class="section">
          <h2>Save/Load Configuration</h2>
  
          <!-- Auto-save status -->
          <div style="margin-bottom: 15px; padding: 10px; background-color: rgba(60, 60, 60, 0.8); border-radius: 4px;">
            <div style="color: #4CAF50; margin-bottom: 5px;">
              <small>‚úÖ Auto-saved: <span id="lastSaved">Never</span></small>
            </div>
            <div style="color: #00ccff;">
              <small>üíæ Save Slots: 
                <button onclick="saveToSlot(1)" style="padding: 4px 8px; margin: 2px;">Save 1</button>
                <button onclick="loadFromSlot(1)" style="padding: 4px 8px; margin: 2px;">Load 1</button>
                <button onclick="saveToSlot(2)" style="padding: 4px 8px; margin: 2px;">Save 2</button>
                <button onclick="loadFromSlot(2)" style="padding: 4px 8px; margin: 2px;">Load 2</button>
                <button onclick="saveToSlot(3)" style="padding: 4px 8px; margin: 2px;">Save 3</button>
                <button onclick="loadFromSlot(3)" style="padding: 4px 8px; margin: 2px;">Load 3</button>
              </small>
            </div>
          </div>
  
          <!-- File-based options -->
          <button onclick="downloadSaveFile()">‚¨áÔ∏è Download Save File</button>
          <input type="file" id="uploadFile" accept=".json" onchange="uploadSaveFile(event)" style="display: none;">
          <button onclick="document.getElementById('uploadFile').click()">‚¨ÜÔ∏è Upload Save File</button>
          <button onclick="clearAllData()" style="background-color: #ff4444; margin-left: 10px;">üóëÔ∏è Clear All Data</button>
        </div>
      </div>
    </div>
  </div>
</body>
</html>

<script>
// Global arrays to track current cargo
let currentBackpackItems = [];
let currentBodySlotItems = {
  leftArm: null,
  rightArm: null,
  leftLeg: null,
  rightLeg: null
};

function updateCurrentLoad() {
  // Calculate totals from backpack items
  const backpackWeight = currentBackpackItems.reduce((sum, item) => sum + (item.weight || 0), 0);
  const backpackSize = currentBackpackItems.reduce((sum, item) => sum + (item.size || 0), 0);
  
  // Calculate totals from body slot items
  const bodySlotWeight = Object.values(currentBodySlotItems)
    .filter(item => item !== null)
    .reduce((sum, item) => sum + (item.weight || 0), 0);
  
  const bodySlotCount = Object.values(currentBodySlotItems).filter(item => item !== null).length;
  
  // Total weight includes both backpack AND body slot items
  const totalWeight = backpackWeight + bodySlotWeight;
  const totalSize = backpackSize + bodySlotCount; // Body slots are always 1 unit each
  
  // Update summary display
  const summary = document.getElementById('current-load-summary');
  summary.innerHTML = `
    <h4>Current Load Summary:</h4>
    <p><strong>Carried on Back:</strong> ${currentBackpackItems.length} items, ${backpackWeight.toFixed(1)}kg, ${backpackSize} units</p>
    <p><strong>Suit Slots:</strong> ${bodySlotCount}/4 occupied, ${bodySlotWeight.toFixed(1)}kg</p>
    <p><strong>Total Weight:</strong> ${totalWeight.toFixed(1)}kg</p>
    <p><strong>Total Size:</strong> ${totalSize} units</p>
  `;
  
  // Update the capacity calculations with the correct total weight
  calculateCarryingCapacity(totalWeight);
}


function toggleBodySlot(slot) {
  const status = document.getElementById(slot + 'Status').value;
  const details = document.getElementById(slot + 'Details');
  
  if (status === 'occupied') {
    details.style.display = 'block';
  } else {
    details.style.display = 'none';
    // Clear the input fields when set to empty
    document.getElementById(slot + 'Name').value = '';
    document.getElementById(slot + 'Weight').value = '';
    document.getElementById(slot + 'Priority').value = '';
    currentBodySlotItems[slot] = null;
  }
  updateBodySlot(slot);
}

function updateBodySlot(slot) {
  const status = document.getElementById(slot + 'Status').value;
  
  if (status === 'occupied') {
    const name = document.getElementById(slot + 'Name').value || 'Unnamed Item';
    const weight = parseFloat(document.getElementById(slot + 'Weight').value) || 0;
    const priority = parseInt(document.getElementById(slot + 'Priority').value) || 3;
    
    currentBodySlotItems[slot] = {
      name: name,
      weight: weight,
      size: 1, // Always 1 for body slots
      priority: priority
    };
  } else {
    currentBodySlotItems[slot] = null;
  }
  
  updateCurrentLoad();
}

function addBackpackItem() {
  const item = {
    id: Date.now(), // Simple unique ID
    name: '',
    weight: 0,
    size: 1,
    priority: 3
  };
  
  currentBackpackItems.push(item);
  renderBackpackItems();
  updateCurrentLoad();
}

function renderBackpackItems() {
  const container = document.getElementById('backpack-items');
  container.innerHTML = '';
  
  currentBackpackItems.forEach((item, index) => {
    const itemDiv = document.createElement('div');
    itemDiv.className = 'cargo-item';
    itemDiv.innerHTML = `
      <label>Name: <input type="text" value="${item.name}" onchange="updateBackpackItem(${index}, 'name', this.value)" /></label>
      <label>Weight: <input type="number" step="0.1" value="${item.weight}" onchange="updateBackpackItem(${index}, 'weight', parseFloat(this.value))" /></label>
      <label>Size: 
        <select onchange="updateBackpackItem(${index}, 'size', parseInt(this.value))">
          <option value="1" ${item.size === 1 ? 'selected' : ''}>S (1 unit)</option>
          <option value="2" ${item.size === 2 ? 'selected' : ''}>M (2 units)</option>
          <option value="4" ${item.size === 4 ? 'selected' : ''}>L (4 units)</option>
          <option value="6" ${item.size === 6 ? 'selected' : ''}>XL (6 units)</option>
        </select>
      </label>
      <label>Priority: <input type="number" min="1" max="5" value="${item.priority}" onchange="updateBackpackItem(${index}, 'priority', parseInt(this.value))" /></label>
      <button onclick="removeBackpackItem(${index})" style="background-color: #ff4444;">Remove</button>
    `;
    container.appendChild(itemDiv);
  });
}

function updateBackpackItem(index, field, value) {
  if (currentBackpackItems[index]) {
    currentBackpackItems[index][field] = value;
    updateCurrentLoad();
  }
}

function removeBackpackItem(index) {
  currentBackpackItems.splice(index, 1);
  renderBackpackItems();
  updateCurrentLoad();
}

function updateCurrentLoad() {
  // Calculate totals from backpack items
  const backpackWeight = currentBackpackItems.reduce((sum, item) => sum + (item.weight || 0), 0);
  const backpackSize = currentBackpackItems.reduce((sum, item) => sum + (item.size || 0), 0);
  
  // Calculate totals from body slot items
  const bodySlotWeight = Object.values(currentBodySlotItems)
    .filter(item => item !== null)
    .reduce((sum, item) => sum + (item.weight || 0), 0);
  
  const bodySlotCount = Object.values(currentBodySlotItems).filter(item => item !== null).length;
  
  // Total weight includes both backpack AND body slot items
  const totalWeight = backpackWeight + bodySlotWeight;
  const totalSize = backpackSize + bodySlotCount; // Body slots are always 1 unit each
  
  // Update summary display
  const summary = document.getElementById('current-load-summary');
  summary.innerHTML = `
    <h4>Current Load Summary:</h4>
    <p><strong>Carried on Back:</strong> ${currentBackpackItems.length} items, ${backpackWeight.toFixed(1)}kg, ${backpackSize} units</p>
    <p><strong>Attached to Suit:</strong> ${bodySlotCount}/4 occupied, ${bodySlotWeight.toFixed(1)}kg</p>
    <p><strong>Total Weight:</strong> ${totalWeight.toFixed(1)}kg</p>
    <p><strong>Total Size:</strong> ${totalSize} units</p>
  `;
  
  // Calculate capacity with the correct total weight
  calculateCarryingCapacity(totalWeight, backpackSize, bodySlotCount);
}

function calculateCarryingCapacity(totalWeight, backpackSize, bodySlotCount) {
  // Calculate weight capacity
  const baseCapacity = parseInt(document.getElementById('baseCapacity').value) || 125;
  const gearWeight = parseFloat(document.getElementById('gearWeight').value) || 0;
  const chiraliumCrystals = parseInt(document.getElementById('chiraliumCrystals').value) || 0;
  const chiraliumBoost = Math.floor(chiraliumCrystals / 1000 * 10) / 10;
  
  const effectiveWeightCapacity = baseCapacity + chiraliumBoost - gearWeight;
  
  // Use the passed parameters instead of recalculating
  const remainingWeight = effectiveWeightCapacity - (totalWeight || 0);
  const remainingBackpackSpace = 28 - (backpackSize || 0);
  const remainingBodySlots = 4 - (bodySlotCount || 0);
  
  // Update displays
  document.getElementById('chiralium-boost').innerHTML = 
    `Chiralium Boost: +${chiraliumBoost.toFixed(1)}kg (${chiraliumCrystals} crystals)`;
  
  document.getElementById('effective-capacity').innerHTML = 
    `Effective Carrying Capacity: ${effectiveWeightCapacity.toFixed(1)}kg`;
  
  // Update load status
  let statusColor = '#4CAF50';
  let statusText = 'Light Load';
  
  if (remainingWeight <= 0 || remainingBackpackSpace <= 0) {
    statusColor = '#990F02';
    statusText = 'OVER CAPACITY!!!';
  }
  else if (remainingWeight < 5 || remainingBackpackSpace < 2) {
    statusColor = '#ff4444';
    statusText = 'Near Capacity!';
  } else if (remainingWeight < 15 || remainingBackpackSpace < 5) {
    statusColor = '#ffaa00';
    statusText = 'Heavy Load';
  }
  
  // Add capacity status to summary
  const summary = document.getElementById('current-load-summary');
  summary.innerHTML += `
    <p><span style="color: ${statusColor}"><strong>Status:</strong> ${statusText}</span></p>
    <p><strong>Remaining:</strong> ${remainingWeight.toFixed(1)}kg weight, ${remainingBackpackSpace} back units, ${remainingBodySlots} suit slots</p>
  `;
}

function addCargoItem() {
  const container = document.getElementById('available-cargo');
  const itemId = Date.now() + Math.random(); // Unique ID for tracking
  const newItem = document.createElement('div');
  newItem.className = 'cargo-item';
  newItem.setAttribute('data-item-id', itemId);
  newItem.innerHTML = `
    <label>Item Name: <input type="text" placeholder="Cargo Item" /></label>
    <label>Weight: <input type="number" step="0.1" placeholder="10.0" /></label>
    <label>Size: 
      <select class="cargo-size">
        <option value="1">S (1 unit)</option>
        <option value="2">M (2 units)</option>
        <option value="4">L (4 units)</option>
        <option value="6">XL (6 units)</option>
      </select>
    </label>
    <label>Priority: <input type="number" min="1" max="5" placeholder="3" /></label>
    <button onclick="removeAvailableItem('${itemId}')" style="background-color: #ff4444;">Remove</button>
  `;
  container.appendChild(newItem);
}

function removeAvailableItem(itemId) {
  const item = document.querySelector(`[data-item-id="${itemId}"]`);
  if (item) {
    item.remove();
  }
}

function optimizeCargo() {
  const strategy = document.getElementById('greedyStrategy').value;
  const availableItems = getAvailableCargoItems();
  
  if (availableItems.length === 0) {
    document.getElementById('results').innerHTML = '<p style="color: #ff4444;">No available cargo items to optimize!</p>';
    return;
  }
  
  // Calculate remaining capacity
  const capacity = getRemainingCapacity();
  
  // Run greedy optimization
  const result = greedyOptimization(availableItems, capacity, strategy);
  
  // Display results
  displayOptimizationResults(result, strategy);
}

function getAvailableCargoItems() {
  const items = [];
  const cargoItems = document.querySelectorAll('#available-cargo .cargo-item');
  
  cargoItems.forEach((item, index) => {
    const name = item.querySelector('input[type="text"]').value || `Item ${index + 1}`;
    const weight = parseFloat(item.querySelector('input[type="number"]').value) || 0;
    const size = parseInt(item.querySelector('.cargo-size').value) || 1;
    const priority = parseInt(item.querySelector('input[min="1"]').value) || 3;
    
    if (weight > 0) { // Only include items with weight
      items.push({ name, weight, size, priority, index });
    }
  });
  
  return items;
}

function getRemainingCapacity() {
  // Calculate current load
  const backpackWeight = currentBackpackItems.reduce((sum, item) => sum + (item.weight || 0), 0);
  const backpackSize = currentBackpackItems.reduce((sum, item) => sum + (item.size || 0), 0);
  const bodySlotWeight = Object.values(currentBodySlotItems)
    .filter(item => item !== null)
    .reduce((sum, item) => sum + (item.weight || 0), 0);
  const bodySlotCount = Object.values(currentBodySlotItems).filter(item => item !== null).length;
  
  // Calculate capacity
  const baseCapacity = parseInt(document.getElementById('baseCapacity').value) || 120;
  const gearWeight = parseFloat(document.getElementById('gearWeight').value) || 0;
  const chiraliumCrystals = parseInt(document.getElementById('chiraliumCrystals').value) || 0;
  const chiraliumBoost = Math.floor(chiraliumCrystals / 1000 * 10) / 10;
  
  const maxWeight = baseCapacity + chiraliumBoost - gearWeight;
  const maxBackpackSize = 28;
  const maxBodySlots = 4;
  
  return {
    remainingWeight: maxWeight - (backpackWeight + bodySlotWeight),
    remainingBackpackSize: maxBackpackSize - backpackSize,
    remainingBodySlots: maxBodySlots - bodySlotCount
  };
}

function greedyOptimization(items, capacity, strategy) {
  // Sort items based on strategy
  let sortedItems = [...items];
  
  switch (strategy) {
    case 'value-weight':
      sortedItems.sort((a, b) => (b.priority / b.weight) - (a.priority / a.weight));
      break;
    case 'priority-first':
      sortedItems.sort((a, b) => {
        if (b.priority !== a.priority) return b.priority - a.priority;
        return (b.priority / b.weight) - (a.priority / a.weight); // Tiebreaker
      });
      break;
    case 'size-efficiency':
      sortedItems.sort((a, b) => (b.priority / b.size) - (a.priority / a.size));
      break;
  }
  
  const selected = [];
  let currentWeight = 0;
  let currentBackpackSize = 0;
  let currentBodySlots = 0;
  
  for (const item of sortedItems) {
    const fitsWeight = currentWeight + item.weight <= capacity.remainingWeight;
    const fitsBackpack = item.size === 1 ? 
      (currentBodySlots < capacity.remainingBodySlots || currentBackpackSize + item.size <= capacity.remainingBackpackSize) :
      currentBackpackSize + item.size <= capacity.remainingBackpackSize;
    
    if (fitsWeight && fitsBackpack) {
      selected.push(item);
      currentWeight += item.weight;
      
      if (item.size === 1 && currentBodySlots < capacity.remainingBodySlots) {
        currentBodySlots++;
      } else {
        currentBackpackSize += item.size;
      }
    }
  }
  
  return {
    items: selected,
    totalWeight: currentWeight,
    totalSize: currentBackpackSize + currentBodySlots,
    strategy: strategy
  };
}

function displayOptimizationResults(result, strategy) {
  const strategyNames = {
    'value-weight': 'Value/Weight Ratio',
    'priority-first': 'Priority First',
    'size-efficiency': 'Size Efficiency'
  };
  
  let html = `
    <div style="background-color: rgba(60, 60, 60, 0.9); padding: 15px; border-radius: 6px;">
      <h4>Optimization Results (${strategyNames[strategy]})</h4>
      <p><strong>Selected ${result.items.length} items:</strong></p>
      <ul>
  `;
  
  result.items.forEach(item => {
    html += `<li>${item.name} - ${item.weight}kg, ${item.size === 1 ? 'S' : item.size === 2 ? 'M' : item.size === 4 ? 'L' : 'XL'}, Priority ${item.priority}</li>`;
  });
  
  html += `
      </ul>
      <p><strong>Total:</strong> ${result.totalWeight.toFixed(1)}kg, ${result.totalSize} units</p>
      <div style="margin-top: 15px;">
        <button onclick="applyOptimization()" style="background-color: #2196F3; margin-right: 10px;">
          üì¶ Apply to Sam's Load
        </button>
        <button onclick="clearResults()" style="background-color: #666;">
          Clear Results
        </button>
      </div>
    </div>
  `;
  
  document.getElementById('results').innerHTML = html;
  
  // Store the result globally so applyOptimization can access it
  window.lastOptimizationResult = result;
}

// Update calculations when values change
document.addEventListener('input', function() {
  updateCurrentLoad();
});

// Calculate on page load
window.addEventListener('load', function() {
  updateCurrentLoad();
});

// Add this to your initialization
document.addEventListener('DOMContentLoaded', function() {
  // Handle when user finishes typing (clicks away or presses Enter)
  document.addEventListener('blur', function(e) {
    if (e.target.type === 'number' && e.target.min && e.target.max) {
      validateNumberInput(e.target);
    }
  }, true);
  
  // Handle when user changes the value and moves on
  document.addEventListener('change', function(e) {
    if (e.target.type === 'number' && e.target.min && e.target.max) {
      validateNumberInput(e.target);
    }
  });
});

function validateNumberInput(input) {
  const min = parseInt(input.min);
  const max = parseInt(input.max);
  let value = parseInt(input.value);
  
  // Handle empty or invalid input
  if (isNaN(value)) {
    if (input.placeholder) {
      value = parseInt(input.placeholder) || min;
    } else {
      value = min;
    }
  }
  
  // Clamp to valid range
  if (value < min) value = min;
  if (value > max) value = max;
  
  // Update the input field
  input.value = value;
  
  // Trigger any change handlers
  input.dispatchEvent(new Event('input', { bubbles: true }));
}

function applyOptimization() {
  if (!window.lastOptimizationResult) {
    alert('No optimization results to apply!');
    return;
  }
  
  const result = window.lastOptimizationResult;
  
  // Add items to backpack and body slots
  result.items.forEach(item => {
    if (item.size === 1) {
      // Try to place S items in body slots first
      if (!addToBodySlot(item)) {
        // If body slots full, add to backpack
        addToBackpack(item);
      }
    } else {
      // M, L, XL items go to backpack
      addToBackpack(item);
    }
    
    // Remove item from available cargo
    removeAvailableItemByIndex(item.index);
  });
  
  // Update the display
  renderBackpackItems();
  updateCurrentLoad();
  
  // Show confirmation
  document.getElementById('results').innerHTML += `
    <p style="color: #4CAF50; margin-top: 10px;">
      ‚úÖ Optimization applied! ${result.items.length} items added to Sam's load and removed from available cargo.
    </p>
  `;
}

function removeAvailableItemByIndex(index) {
  const cargoItems = document.querySelectorAll('#available-cargo .cargo-item');
  if (cargoItems[index]) {
    cargoItems[index].remove();
  }
}

function addToBodySlot(item) {
  const slots = ['leftArm', 'rightArm', 'leftLeg', 'rightLeg'];
  
  for (const slot of slots) {
    if (currentBodySlotItems[slot] === null) {
      // Set the dropdown to occupied
      document.getElementById(slot + 'Status').value = 'occupied';
      
      // Show the input fields
      document.getElementById(slot + 'Details').style.display = 'block';
      
      // Fill in the item data
      document.getElementById(slot + 'Name').value = item.name;
      document.getElementById(slot + 'Weight').value = item.weight;
      document.getElementById(slot + 'Priority').value = item.priority;
      
      // Update the data structure
      currentBodySlotItems[slot] = {
        name: item.name,
        weight: item.weight,
        size: 1,
        priority: item.priority
      };
      
      return true; // Successfully placed
    }
  }
  
  return false; // No empty slots
}

function addToBackpack(item) {
  const newItem = {
    id: Date.now() + Math.random(), // Unique ID
    name: item.name,
    weight: item.weight,
    size: item.size,
    priority: item.priority
  };
  
  currentBackpackItems.push(newItem);
}

function clearResults() {
  document.getElementById('results').innerHTML = '';
  window.lastOptimizationResult = null;
}

// Auto-save functionality
function autoSave() {
  const gameState = createGameState();
  localStorage.setItem('cargoOptimizer_autoSave', JSON.stringify(gameState));
  
  // Update last saved timestamp
  const now = new Date().toLocaleTimeString();
  document.getElementById('lastSaved').textContent = now;
}

// Create game state object (used by both auto-save and manual save)
function createGameState() {
  return {
    version: "1.0",
    samStatus: {
      baseCapacity: document.getElementById('baseCapacity').value,
      gearWeight: document.getElementById('gearWeight').value,
      chiraliumCrystals: document.getElementById('chiraliumCrystals').value
    },
    currentBackpackItems: currentBackpackItems,
    currentBodySlotItems: currentBodySlotItems,
    availableCargo: getAvailableCargoItems(),
    timestamp: new Date().toISOString(),
    metadata: {
      totalItems: currentBackpackItems.length,
      bodySlotCount: Object.values(currentBodySlotItems).filter(item => item !== null).length
    }
  };
}

// Save to numbered slot
function saveToSlot(slotNumber) {
  const gameState = createGameState();
  const slotKey = `cargoOptimizer_slot${slotNumber}`;
  
  localStorage.setItem(slotKey, JSON.stringify(gameState));
  
  // Visual feedback
  const button = event.target;
  const originalText = button.textContent;
  button.textContent = '‚úÖ Saved!';
  button.style.backgroundColor = '#4CAF50';
  
  setTimeout(() => {
    button.textContent = originalText;
    button.style.backgroundColor = '';
  }, 1000);
  
  console.log(`Game saved to slot ${slotNumber}`);
}

// Load from numbered slot
function loadFromSlot(slotNumber) {
  const slotKey = `cargoOptimizer_slot${slotNumber}`;
  const savedState = localStorage.getItem(slotKey);
  
  if (savedState) {
    try {
      const gameState = JSON.parse(savedState);
      loadGameState(gameState);
      
      // Visual feedback
      const button = event.target;
      const originalText = button.textContent;
      button.textContent = '‚úÖ Loaded!';
      button.style.backgroundColor = '#2196F3';
      
      setTimeout(() => {
        button.textContent = originalText;
        button.style.backgroundColor = '';
      }, 1000);
      
      console.log(`Game loaded from slot ${slotNumber}`);
    } catch (error) {
      alert(`Error loading from slot ${slotNumber}: ${error.message}`);
    }
  } else {
    alert(`No save data found in slot ${slotNumber}`);
  }
}

// Load auto-save on page load
function loadAutoSave() {
  const autoSaveData = localStorage.getItem('cargoOptimizer_autoSave');
  if (autoSaveData) {
    try {
      const gameState = JSON.parse(autoSaveData);
      loadGameState(gameState);
      
      // Update last saved display
      const savedTime = new Date(gameState.timestamp).toLocaleTimeString();
      document.getElementById('lastSaved').textContent = savedTime;
      
      console.log('Auto-save loaded successfully');
    } catch (error) {
      console.error('Error loading auto-save:', error);
    }
  }
}

// Enhanced clear all data
function clearAllData() {
  if (confirm('Are you sure you want to clear all data? This will also clear auto-save and all save slots.')) {
    // Clear all arrays
    currentBackpackItems = [];
    currentBodySlotItems = {
      leftArm: null,
      rightArm: null,
      leftLeg: null,
      rightLeg: null
    };
    
    // Reset form values
    document.getElementById('baseCapacity').value = 120;
    document.getElementById('gearWeight').value = 0;
    document.getElementById('chiraliumCrystals').value = 0;
    
    // Clear available cargo
    document.getElementById('available-cargo').innerHTML = '';
    
    // Clear results
    document.getElementById('results').innerHTML = '';
    
    // Reset body slots
    restoreBodySlots();
    
    // Clear localStorage
    localStorage.removeItem('cargoOptimizer_autoSave');
    localStorage.removeItem('cargoOptimizer_slot1');
    localStorage.removeItem('cargoOptimizer_slot2');
    localStorage.removeItem('cargoOptimizer_slot3');
    
    // Reset last saved display
    document.getElementById('lastSaved').textContent = 'Never';
    
    // Update displays
    renderBackpackItems();
    updateCurrentLoad();
    
    alert('All data cleared!');
  }
}

// Update existing event listeners to include auto-save
document.addEventListener('input', function() {
  updateCurrentLoad();
  autoSave(); // Add this line
});

// Load auto-save when page loads
window.addEventListener('load', function() {
  updateCurrentLoad();
  loadAutoSave(); // Add this line
});

// Download current state as JSON file
function downloadSaveFile() {
  const gameState = {
    version: "1.0", // For future compatibility
    samStatus: {
      baseCapacity: document.getElementById('baseCapacity').value,
      gearWeight: document.getElementById('gearWeight').value,
      chiraliumCrystals: document.getElementById('chiraliumCrystals').value
    },
    currentBackpackItems: currentBackpackItems,
    currentBodySlotItems: currentBodySlotItems,
    availableCargo: getAvailableCargoItems(),
    timestamp: new Date().toISOString(),
    metadata: {
      totalItems: currentBackpackItems.length,
      bodySlotCount: Object.values(currentBodySlotItems).filter(item => item !== null).length
    }
  };
  
  const dataStr = JSON.stringify(gameState, null, 2);
  const dataBlob = new Blob([dataStr], {type: 'application/json'});
  
  const link = document.createElement('a');
  link.href = URL.createObjectURL(dataBlob);
  link.download = `cargo-optimizer-${new Date().toISOString().split('T')[0]}.json`;
  link.click();
  
  // Clean up
  URL.revokeObjectURL(link.href);
  
  console.log('Save file downloaded!');
}

// Upload and load JSON file
function uploadSaveFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const gameState = JSON.parse(e.target.result);
      loadGameState(gameState);
      alert(`Save file loaded successfully!\nLoaded: ${gameState.metadata?.totalItems || 0} backpack items, ${gameState.metadata?.bodySlotCount || 0} body slot items`);
    } catch (error) {
      alert('Error loading save file: ' + error.message);
      console.error('Save file error:', error);
    }
  };
  reader.readAsText(file);
  
  // Clear the file input so the same file can be loaded again
  event.target.value = '';
}

// Load game state from parsed JSON
function loadGameState(gameState) {
  // Restore Sam's status
  if (gameState.samStatus) {
    document.getElementById('baseCapacity').value = gameState.samStatus.baseCapacity || 120;
    document.getElementById('gearWeight').value = gameState.samStatus.gearWeight || 0;
    document.getElementById('chiraliumCrystals').value = gameState.samStatus.chiraliumCrystals || 0;
  }
  
  // Restore backpack items
  currentBackpackItems = gameState.currentBackpackItems || [];
  
  // Restore body slot items
  currentBodySlotItems = gameState.currentBodySlotItems || {
    leftArm: null,
    rightArm: null,
    leftLeg: null,
    rightLeg: null
  };
  
  // Restore body slot UI
  restoreBodySlots();
  
  // Restore available cargo
  if (gameState.availableCargo) {
    restoreAvailableCargo(gameState.availableCargo);
  }
  
  // Update all displays
  renderBackpackItems();
  updateCurrentLoad();
}

// Restore body slot UI elements
function restoreBodySlots() {
  const slots = ['leftArm', 'rightArm', 'leftLeg', 'rightLeg'];
  
  slots.forEach(slot => {
    const item = currentBodySlotItems[slot];
    const statusSelect = document.getElementById(slot + 'Status');
    const detailsDiv = document.getElementById(slot + 'Details');
    
    if (item) {
      statusSelect.value = 'occupied';
      detailsDiv.style.display = 'block';
      document.getElementById(slot + 'Name').value = item.name || '';
      document.getElementById(slot + 'Weight').value = item.weight || 0;
      document.getElementById(slot + 'Priority').value = item.priority || 3;
    } else {
      statusSelect.value = '';
      detailsDiv.style.display = 'none';
      document.getElementById(slot + 'Name').value = '';
      document.getElementById(slot + 'Weight').value = '';
      document.getElementById(slot + 'Priority').value = '';
    }
  });
}

// Restore available cargo items
function restoreAvailableCargo(availableItems) {
  // Clear existing available cargo
  const container = document.getElementById('available-cargo');
  container.innerHTML = '';
  
  // Add each saved item
  availableItems.forEach(item => {
    const itemDiv = document.createElement('div');
    itemDiv.className = 'cargo-item';
    const itemId = Date.now() + Math.random();
    itemDiv.setAttribute('data-item-id', itemId);
    
    itemDiv.innerHTML = `
      <label>Item Name: <input type="text" value="${item.name || ''}" /></label>
      <label>Weight: <input type="number" step="0.1" value="${item.weight || 0}" /></label>
      <label>Size: 
        <select class="cargo-size">
          <option value="1" ${item.size === 1 ? 'selected' : ''}>S (1 unit)</option>
          <option value="2" ${item.size === 2 ? 'selected' : ''}>M (2 units)</option>
          <option value="4" ${item.size === 4 ? 'selected' : ''}>L (4 units)</option>
          <option value="6" ${item.size === 6 ? 'selected' : ''}>XL (6 units)</option>
        </select>
      </label>
      <label>Priority: <input type="number" min="1" max="5" value="${item.priority || 3}" /></label>
      <button onclick="removeAvailableItem('${itemId}')" style="background-color: #ff4444;">Remove</button>
    `;
    
    container.appendChild(itemDiv);
  });
}

// Clear all data
function clearAllData() {
  if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
    // Clear all arrays
    currentBackpackItems = [];
    currentBodySlotItems = {
      leftArm: null,
      rightArm: null,
      leftLeg: null,
      rightLeg: null
    };
    
    // Reset form values
    document.getElementById('baseCapacity').value = 120;
    document.getElementById('gearWeight').value = 0;
    document.getElementById('chiraliumCrystals').value = 0;
    
    // Clear available cargo
    document.getElementById('available-cargo').innerHTML = '';
    
    // Clear results
    document.getElementById('results').innerHTML = '';
    
    // Reset body slots
    restoreBodySlots();
    
    // Update displays
    renderBackpackItems();
    updateCurrentLoad();
    
    alert('All data cleared!');
  }
}
</script> 